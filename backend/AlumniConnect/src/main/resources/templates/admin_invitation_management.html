<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Qu·∫£n l√Ω L·ªùi m·ªùi</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:insert="~{layout/base :: styleBase}"></th:block>
    <th:block th:insert="~{layout/base :: scriptBase}"></th:block>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container {
            z-index: 1060 !important;
        }
        .select2-dropdown {
            z-index: 1061 !important;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 0.75rem 1.25rem;
        }

        .selected-groups-list, .selected-users-list {
            max-height: 120px;
            overflow-y: auto;
        }

        .badge .btn-close {
            font-size: 0.6rem;
            padding: 0.25rem;
            opacity: 0.8;
        }

        .badge .btn-close:hover {
            opacity: 1;
        }

        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ced4da;
            min-height: 38px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #495057;
        }
        /* Progress steps styling */
        .progress-steps {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            padding-bottom: 10px;
        }

        .step.active .step-number {
            background-color: #0d6efd;
            color: white;
        }

        .step.active .step-title {
            color: #0d6efd;
            font-weight: 500;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .step-title {
            color: #6c757d;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .step-divider {
            flex-grow: 1;
            height: 2px;
            background-color: #dee2e6;
            margin: 0 10px;
            position: relative;
            top: -15px;
        }

        /* Member list items */
        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .member-item:hover {
            background-color: #f8f9fa;
        }

        .member-item.selected {
            background-color: #e7f1ff;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .member-info {
            flex-grow: 1;
        }

        .member-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .member-email {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Selected members preview */
        .selected-member-preview {
            display: inline-flex;
            align-items: center;
            background-color: #e7f1ff;
            border-radius: 20px;
            padding: 3px 10px 3px 5px;
            margin: 2px;
        }

        .selected-member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 5px;
        }

        .selected-member-name {
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <header th:replace="~{layout/base :: header}"></header>

    <main class="container mt-5">
        <div class="card shadow-sm rounded-4 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-primary"><i class="bi bi-envelope-check-fill me-2"></i>Qu·∫£n l√Ω s·ª± ki·ªán</h2>
                    <button class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#createInvitationModal">
                        <i class="bi bi-plus-lg me-2"></i>T·∫°o l·ªùi m·ªùi m·ªõi
                    </button>
                </div>

                <!-- Form t√¨m ki·∫øm -->
                <form th:action="@{/admin/invitations}" method="get" class="mb-4">
                    <div class="input-group">
                        <input type="text" class="form-control" name="eventName" 
                               th:value="${eventName}" placeholder="üîç T√¨m theo t√™n s·ª± ki·ªán">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="bi bi-search"></i> T√¨m
                        </button>
                    </div>
                </form>

                <!-- B·∫£ng danh s√°ch l·ªùi m·ªùi -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>T√™n s·ª± ki·ªán</th>
                                <th>Th·ªùi gian</th>
                                <th>Ng∆∞·ªùi/Nh√≥m m·ªùi</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="invitation, iterStat : ${invitations}">
                                <td th:text="${iterStat.count}"></td>
                                <td>
                                    <a href="#" class="text-decoration-none" 
                                       th:onclick="'viewInvitationDetail(\'' + ${invitation.id} + '\')'"
                                       th:text="${invitation.eventName}"></a>
                                </td>
                                <td th:text="${#temporals.format(invitation.eventTime, 'dd/MM/yyyy HH:mm')}"></td>
                                <td>
                                    <span class="badge bg-primary me-1" 
                                          th:text="${invitation.userSet.size()} + ' ng∆∞·ªùi'"></span>
                                    <span class="badge bg-info" 
                                          th:text="${invitation.ugroupSet.size()} + ' nh√≥m'"></span>
                                </td>
                                <td>
                                    <span th:class="${invitation.post.active} ? 'badge bg-success' : 'badge bg-secondary'"
                                          th:text="${invitation.post.active} ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ ƒë√≥ng'"></span>
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-outline-info btn-sm rounded-pill"
                                                th:onclick="'viewInvitationDetail(\'' + ${invitation.id} + '\')'">
                                            <i class="bi bi-eye"></i> 
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm rounded-pill"
                                                th:onclick="'openEditInvitationModal(\'' + ${invitation.id} + '\')'">
                                            <i class="bi bi-pencil-square"></i> 
                                        </button>
                                        <button th:if="${invitation.post.active}"
                                                class="btn btn-outline-danger btn-sm rounded-pill"
                                                th:onclick="'toggleInvitationStatus(\'' + ${invitation.id} + '\', false)'">
                                            <i class="bi bi-x-circle"></i> 
                                        </button>
                                        <button th:if="${!invitation.post.active}"
                                                class="btn btn-outline-success btn-sm rounded-pill"
                                                th:onclick="'toggleInvitationStatus(\'' + ${invitation.id} + '\', true)'">
                                            <i class="bi bi-check-circle"></i> 
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm rounded-pill"
                                                th:onclick="'deleteInvitationPermanently(' + ${invitation.id} + ')'">
                                            <i class="bi bi-trash"></i> 
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Ph√¢n trang -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mt-4">
                        <li th:class="${currentPage > 1} ? 'page-item' : 'page-item disabled'">
                            <a class="page-link" th:href="@{/admin/invitations(page=${currentPage - 1}, size=${size}, eventName=${eventName})}">
                                <i class="bi bi-chevron-left"></i> Tr∆∞·ªõc
                            </a>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link" th:text="'Trang ' + ${currentPage} + ' / ' + ${totalPages}"></span>
                        </li>
                        <li th:class="${currentPage < totalPages} ? 'page-item' : 'page-item disabled'">
                            <a class="page-link" th:href="@{/admin/invitations(page=${currentPage + 1}, size=${size}, eventName=${eventName})}">
                                Ti·∫øp <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </main>

    <!-- Modal t·∫°o l·ªùi m·ªùi m·ªõi -->
    <div class="modal fade" id="createInvitationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üì© T·∫°o l·ªùi m·ªùi m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>

                <form id="createInvitationForm" class="needs-validation" novalidate>
                    <div class="modal-body px-4 py-3">
                        <div class="row g-4">
                            <!-- Left: Th√¥ng tin s·ª± ki·ªán -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventName" class="form-label fw-semibold">T√™n s·ª± ki·ªán <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="eventName" name="eventName" placeholder="Nh·∫≠p t√™n s·ª± ki·ªán" required>
                                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p t√™n s·ª± ki·ªán.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="eventTime" class="form-label fw-semibold">Th·ªùi gian s·ª± ki·ªán <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="eventTime" name="eventTime" required>
                                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn th·ªùi gian h·ª£p l·ªá.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Kho√° b√¨nh lu·∫≠n</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="lockComment" name="lockComment">
                                        <label class="form-check-label" for="lockComment">Kh√¥ng cho ph√©p ng∆∞·ªùi kh√°c b√¨nh lu·∫≠n</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: N·ªôi dung & h√¨nh ·∫£nh -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="invitationContent" class="form-label fw-semibold">N·ªôi dung <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="invitationContent" name="content" rows="6" placeholder="N·ªôi dung chi ti·∫øt l·ªùi m·ªùi..." required></textarea>
                                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p n·ªôi dung.</div>
                                </div>
                            </div>
                        </div>

                        <!-- M·ªùi nh√≥m v√† ng∆∞·ªùi d√πng -->
                        <div class="row g-4 mt-1">
                            <!-- Ph·∫ßn m·ªùi nh√≥m -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                        <h6 class="mb-0">üéØ M·ªùi theo nh√≥m</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" data-bs-target="#integratedGroupModal">
                                            <i class="bi bi-plus-lg"></i> T·∫°o nh√≥m m·ªõi
                                        </button>

                                    </div>
                                    <div class="card-body">
                                        <select class="form-select select2-groups" name="groups" multiple="multiple">
                                            <option th:each="group : ${allGroups}" 
                                                    th:value="${group.id}" 
                                                    th:text="${group.groupName}"></option>
                                        </select>
                                        <div class="mt-2">
                                            <small class="text-muted">Ch·ªçn t·ª´ danh s√°ch nh√≥m c√≥ s·∫µn ho·∫∑c t·∫°o nh√≥m m·ªõi</small>
                                        </div>

                                        <!-- Hi·ªÉn th·ªã c√°c nh√≥m ƒë√£ ch·ªçn -->
                                        <div class="selected-groups-container mt-3">
                                            <div class="d-flex flex-wrap gap-2 selected-groups-list">
                                                <!-- C√°c nh√≥m ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ph·∫ßn m·ªùi th√†nh vi√™n -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">üë• M·ªùi th√†nh vi√™n c·ª• th·ªÉ</h6>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select select2-users" name="users" multiple="multiple">
                                            <option th:each="user : ${allUsers}" 
                                                    th:value="${user.id}" 
                                                    th:text="${user.firstName + ' ' + user.lastName + ' (' + user.email + ')'}">
                                            </option>
                                        </select>
                                        <div class="mt-2">
                                            <small class="text-muted">T√¨m ki·∫øm th√†nh vi√™n theo t√™n ho·∫∑c email</small>
                                        </div>

                                        <!-- Hi·ªÉn th·ªã c√°c th√†nh vi√™n ƒë√£ ch·ªçn -->
                                        <div class="selected-users-container mt-3">
                                            <div class="d-flex flex-wrap gap-2 selected-users-list">
                                                <!-- C√°c th√†nh vi√™n ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ·∫¢nh ƒë√≠nh k√®m -->
                        <div class="mt-4">
                            <label for="invitationImages" class="form-label fw-semibold">üì∑ H√¨nh ·∫£nh ƒë√≠nh k√®m (t·ªëi ƒëa 5 ·∫£nh)</label>
                            <input type="file" class="form-control" id="invitationImages" name="images" multiple accept="image/*">
                            <div class="preview-images mt-3 d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Hu·ª∑
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> G·ª≠i l·ªùi m·ªùi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal t·∫°o nh√≥m v√† th√™m th√†nh vi√™n t√≠ch h·ª£p -->
    <div class="modal fade" id="integratedGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-people-fill me-2"></i>T·∫°o nh√≥m m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>

                <!-- Progress steps indicator -->
                <div class="progress-steps px-4 pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="step active" data-step="1">
                            <span class="step-number">1</span>
                            <span class="step-title">Th√¥ng tin nh√≥m</span>
                        </div>
                        <div class="step-divider"></div>
                        <div class="step" data-step="2">
                            <span class="step-number">2</span>
                            <span class="step-title">Th√†nh vi√™n</span>
                        </div>
                        <div class="step-divider"></div>
                        <div class="step" data-step="3">
                            <span class="step-number">3</span>
                            <span class="step-title">Ho√†n t·∫•t</span>
                        </div>
                    </div>
                </div>

                <form id="integratedGroupForm">
                    <!-- Step 1: Group Info -->
                    <div class="modal-body step-content" data-step="1">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">T√™n nh√≥m <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="groupName" name="groupName" required>
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p t√™n nh√≥m</div>
                        </div>

                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">M√¥ t·∫£ nh√≥m</label>
                            <textarea class="form-control" id="groupDescription" name="description" rows="3" placeholder="M√¥ t·∫£ m·ª•c ƒë√≠ch c·ªßa nh√≥m..."></textarea>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary next-step" data-next="2">Ti·∫øp theo <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>

                    <!-- Step 2: Add Members -->
                    <div class="modal-body step-content d-none" data-step="2">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-semibold">Th√™m th√†nh vi√™n</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllMembers">
                                    <label class="form-check-label" for="selectAllMembers">Ch·ªçn t·∫•t c·∫£</label>
                                </div>
                            </div>

                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="memberSearch" placeholder="T√¨m ki·∫øm th√†nh vi√™n...">
                            </div>

                            <div id="membersList" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="1"><i class="bi bi-arrow-left me-1"></i> Quay l·∫°i</button>
                            <button type="button" class="btn btn-primary next-step" data-next="3">Ti·∫øp theo <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>

                    <!-- Step 3: Review & Complete -->
                    <div class="modal-body step-content d-none" data-step="3">
                        <div class="text-center mb-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">X√°c nh·∫≠n t·∫°o nh√≥m</h5>
                        </div>

                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Th√¥ng tin nh√≥m</h6>
                                <div class="mb-2">
                                    <strong>T√™n nh√≥m:</strong> <span id="reviewGroupName" class="text-primary"></span>
                                </div>
                                <div>
                                    <strong>M√¥ t·∫£:</strong> <span id="reviewGroupDescription" class="text-muted"></span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Th√†nh vi√™n ƒë√£ ch·ªçn (<span id="selectedMembersCount">0</span>)</h6>
                                <div id="selectedMembersPreview" class="d-flex flex-wrap gap-2 mt-2">
                                    <div class="text-muted">Kh√¥ng c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ch·ªçn</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="2"><i class="bi bi-arrow-left me-1"></i> Quay l·∫°i</button>
                            <button type="submit" class="btn btn-success">Ho√†n t·∫•t <i class="bi bi-check-lg ms-1"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a l·ªùi m·ªùi -->
    <div class="modal fade" id="editInvitationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">‚úèÔ∏è Ch·ªânh s·ª≠a l·ªùi m·ªùi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>

                <form id="editInvitationForm" class="needs-validation" novalidate>
                    <input type="hidden" id="editInvitationId" name="id">
                    <div class="modal-body px-4 py-3">
                        <div class="row g-4">
                            <!-- Left: Th√¥ng tin s·ª± ki·ªán -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEventName" class="form-label fw-semibold">T√™n s·ª± ki·ªán <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editEventName" name="eventName" required>
                                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p t√™n s·ª± ki·ªán.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="editEventTime" class="form-label fw-semibold">Th·ªùi gian s·ª± ki·ªán <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="editEventTime" name="eventTime" required>
                                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn th·ªùi gian h·ª£p l·ªá.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Kho√° b√¨nh lu·∫≠n</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="editLockComment" name="lockComment">
                                        <label class="form-check-label" for="editLockComment">Kh√¥ng cho ph√©p ng∆∞·ªùi kh√°c b√¨nh lu·∫≠n</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: N·ªôi dung & h√¨nh ·∫£nh -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editInvitationContent" class="form-label fw-semibold">N·ªôi dung <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="editInvitationContent" name="content" rows="6" placeholder="N·ªôi dung chi ti·∫øt l·ªùi m·ªùi..." required></textarea>
                                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p n·ªôi dung.</div>
                                </div>
                            </div>
                        </div>

                        <!-- M·ªùi nh√≥m v√† ng∆∞·ªùi d√πng -->
                        <div class="row g-4 mt-1">
                            <!-- Ph·∫ßn m·ªùi nh√≥m -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                        <h6 class="mb-0">üéØ M·ªùi theo nh√≥m</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                            <i class="bi bi-plus-lg"></i> T·∫°o nh√≥m m·ªõi
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select select2-groups-edit" name="groups" multiple="multiple">
                                            <option th:each="group : ${allGroups}" 
                                                    th:value="${group.id}" 
                                                    th:text="${group.groupName}"></option>
                                        </select>
                                        <div class="mt-2">
                                            <small class="text-muted">Ch·ªçn t·ª´ danh s√°ch nh√≥m c√≥ s·∫µn ho·∫∑c t·∫°o nh√≥m m·ªõi</small>
                                        </div>

                                        <!-- Hi·ªÉn th·ªã c√°c nh√≥m ƒë√£ ch·ªçn -->
                                        <div class="selected-groups-container mt-3">
                                            <div class="d-flex flex-wrap gap-2 selected-groups-list-edit">
                                                <!-- C√°c nh√≥m ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ph·∫ßn m·ªùi th√†nh vi√™n -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">üë• M·ªùi th√†nh vi√™n c·ª• th·ªÉ</h6>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select select2-users-edit" name="users" multiple="multiple">
                                            <option th:each="user : ${allUsers}" 
                                                    th:value="${user.id}" 
                                                    th:text="${user.firstName + ' ' + user.lastName + ' (' + user.email + ')'}"></option>
                                        </select>
                                        <div class="mt-2">
                                            <small class="text-muted">T√¨m ki·∫øm th√†nh vi√™n theo t√™n ho·∫∑c email</small>
                                        </div>

                                        <!-- Hi·ªÉn th·ªã c√°c th√†nh vi√™n ƒë√£ ch·ªçn -->
                                        <div class="selected-users-container mt-3">
                                            <div class="d-flex flex-wrap gap-2 selected-users-list-edit">
                                                <!-- C√°c th√†nh vi√™n ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ·∫¢nh ƒë√≠nh k√®m -->
                        <div class="mt-4">
                            <label for="editInvitationImages" class="form-label fw-semibold">üì∑ H√¨nh ·∫£nh ƒë√≠nh k√®m (t·ªëi ƒëa 5 ·∫£nh)</label>
                            <input type="file" class="form-control" id="editInvitationImages" name="images" multiple accept="image/*">
                            <div class="edit-preview-images mt-3 d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Hu·ª∑
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> L∆∞u thay ƒë·ªïi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal xem chi ti·∫øt l·ªùi m·ªùi -->
    <div class="modal fade" id="viewInvitationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi ti·∫øt l·ªùi m·ªùi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3 id="detailEventName" class="text-primary"></h3>
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-clock"></i> 
                                    <span id="detailEventTime"></span>
                                </span>
                                <span id="detailInvitationStatus" class="badge"></span>
                            </div>
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-card-text"></i> N·ªôi dung</h6>
                                    <p id="detailInvitationContent" class="card-text mt-2"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-person"></i> Ng∆∞·ªùi t·∫°o</h6>
                                    <div id="creatorInfo" class="d-flex align-items-center mt-3">
                                        <!-- Th√¥ng tin ng∆∞·ªùi t·∫°o -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-people"></i> Nh√≥m ƒë∆∞·ª£c m·ªùi</h6>
                                    <div id="invitedGroupsList" class="mt-3">
                                        <!-- Danh s√°ch nh√≥m -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-person-lines-fill"></i> Th√†nh vi√™n ƒë∆∞·ª£c m·ªùi</h6>
                                    <div id="invitedUsersList" class="mt-3">
                                        <!-- Danh s√°ch th√†nh vi√™n -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" id="invitationImagesGallery">
                        <!-- Gallery h√¨nh ·∫£nh -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{layout/base :: footer}"></footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/group-management.js}"></script>

    <script th:src="@{/js/invitation-management.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
//        $(document).ready(function () {
//            // H√†m kh·ªüi t·∫°o Select2 kh√¥ng g√¢y gi·∫≠t
//            function initSmoothSelect2(selector, placeholder) {
//                $(selector).each(function () {
//                    // T·∫°o m·ªôt b·∫£n sao ·∫©n c·ªßa select element
//                    const originalSelect = $(this);
//                    const hiddenSelect = originalSelect.clone()
//                            .removeAttr('id')
//                            .addClass('select2-hidden')
//                            .insertAfter(originalSelect);
//
//                    // ·∫®n select g·ªëc nh∆∞ng v·∫´n gi·ªØ layout
//                    originalSelect.addClass('select2-original').css({
//                        'position': 'absolute',
//                        'opacity': 0,
//                        'height': '100%',
//                        'width': '100%'
//                    });
//
//                    // Kh·ªüi t·∫°o Select2 tr√™n b·∫£n sao ·∫©n
//                    hiddenSelect.select2({
//                        placeholder: placeholder,
//                        width: '100%',
//                        dropdownParent: originalSelect.closest('.modal'),
//                        minimumResultsForSearch: 5
//                    });
//
//                    // ƒê·ªìng b·ªô gi√° tr·ªã gi·ªØa select g·ªëc v√† select2
//                    hiddenSelect.on('change', function () {
//                        originalSelect.val($(this).val()).trigger('change');
//                    });
//                });
//            }
//
//            // X·ª≠ l√Ω modal
//            $('#createInvitationModal, #editInvitationModal').on('shown.bs.modal', function () {
//                // Kh·ªüi t·∫°o Select2 m∆∞·ª£t m√†
//                if ($(this).attr('id') === 'createInvitationModal') {
//                    initSmoothSelect2('.select2-groups', "Ch·ªçn nh√≥m...");
//                    initSmoothSelect2('.select2-users', "Ch·ªçn th√†nh vi√™n...");
//                } else {
//                    initSmoothSelect2('.select2-groups-edit', "Ch·ªçn nh√≥m...");
//                    initSmoothSelect2('.select2-users-edit', "Ch·ªçn th√†nh vi√™n...");
//                }
//            }).on('hidden.bs.modal', function () {
//                // D·ªçn d·∫πp khi ƒë√≥ng modal
//                $(this).find('.select2-hidden').select2('destroy').remove();
//                $(this).find('.select2-original').removeClass('select2-original').css({
//                    'position': '',
//                    'opacity': '',
//                    'height': '',
//                    'width': ''
//                });
//            });
//
//            // Th√™m CSS ƒë·ªÉ ·∫©n select g·ªëc
//            const select2Style = document.createElement('style');
//            select2Style.textContent = `
//            .select2-hidden { display: none; }
//            .select2-original { 
//                position: absolute !important;
//                opacity: 0 !important;
//                height: 100% !important;
//                width: 100% !important;
//                z-index: 1 !important;
//            }
//        `;
//            document.head.appendChild(select2Style);
//
//            // X·ª≠ l√Ω preview ·∫£nh (gi·ªØ nguy√™n)
//            $('#invitationImages, #editInvitationImages').change(function () {
//                const isEdit = $(this).attr('id') === 'editInvitationImages';
//                const preview = $(this).siblings(isEdit ? '.edit-preview-images' : '.preview-images');
//                preview.empty();
//
//                if (this.files.length > 5) {
//                    alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 5 ·∫£nh');
//                    this.value = '';
//                    return;
//                }
//
//                Array.from(this.files).forEach(file => {
//                    const reader = new FileReader();
//                    reader.onload = (e) => {
//                        preview.append(`<img src="${e.target.result}" class="img-thumbnail" width="100">`);
//                    };
//                    reader.readAsDataURL(file);
//                });
//            });
//        });
        $(document).ready(function () {
            function initSmoothSelect2(selector, placeholder) {
                $(selector).each(function () {
                    const originalSelect = $(this);
                    if (originalSelect.next('.select2-hidden').length) {
                        return;
                    }
                    const hiddenSelect = originalSelect.clone()
                            .removeAttr('id')
                            .addClass('select2-hidden')
                            .insertAfter(originalSelect);

                    originalSelect.addClass('select2-original').css({
                        'position': 'absolute',
                        'opacity': 0,
                        'height': '100%',
                        'width': '100%'
                    });

                    hiddenSelect.select2({
                        placeholder: placeholder,
                        width: '100%',
                        dropdownParent: originalSelect.closest('.modal'),
                        minimumResultsForSearch: 5
                    });

                    hiddenSelect.on('change', function () {
                        originalSelect.val($(this).val()).trigger('change');
                    });
                });
            }

            $('#createInvitationModal, #editInvitationModal').on('shown.bs.modal', function () {
                const isEditModal = $(this).attr('id') === 'editInvitationModal';
                const groupSelector = isEditModal ? '.select2-groups-edit' : '.select2-groups';
                const userSelector = isEditModal ? '.select2-users-edit' : '.select2-users';

                initSmoothSelect2(groupSelector, "Ch·ªçn nh√≥m...");
                initSmoothSelect2(userSelector, "Ch·ªçn th√†nh vi√™n...");
            }).on('hidden.bs.modal', function () {
                $(this).find('.select2-hidden').select2('destroy').remove();
                $(this).find('.select2-original').removeClass('select2-original').css({
                    'position': '',
                    'opacity': '',
                    'height': '',
                    'width': ''
                });
            });

            const select2Style = document.createElement('style');
            select2Style.textContent = `
        .select2-hidden { display: none; }
        .select2-original { 
            position: absolute !important;
            opacity: 0 !important;
            height: 100% !important;
            width: 100% !important;
            z-index: 1 !important;
        }
    `;
            document.head.appendChild(select2Style);

            $('#invitationImages, #editInvitationImages').change(function () {
                const previewClass = $(this).attr('id') === 'editInvitationImages' ? '.edit-preview-images' : '.preview-images';
                const preview = $(this).siblings(previewClass);
                preview.empty();

                if (this.files.length > 5) {
                    alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 5 ·∫£nh');
                    this.value = '';
                    return;
                }

                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.append(`<img src="${e.target.result}" class="img-thumbnail" width="100">`);
                    };
                    reader.readAsDataURL(file);
                });
            });
        });
    </script>
</body>
</html>